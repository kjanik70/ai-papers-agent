# .github/workflows/weekly-ai-papers.yml
name: Weekly AI Papers Analysis

on:
  schedule:
    # Run every Friday at 6 PM UTC
    - cron: '0 18 * * 5'
  workflow_dispatch: # Allow manual triggering
  
env:
  PYTHON_VERSION: '3.9'

jobs:
  generate-papers:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Load previous papers data
      run: |
        # Create previous_papers.json if it doesn't exist
        if [ ! -f previous_papers.json ]; then
          echo '{"papers": []}' > previous_papers.json
        fi
        
    - name: Run AI Papers Analysis
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        python ai_papers_agent.py
        
    - name: Commit and push generated content
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Add generated files
        git add *.md previous_papers.json analysis_summary.json
        
        # Check if there are changes to commit
        if git diff --cached --quiet; then
          echo "No changes to commit"
        else
          git commit -m "Weekly AI papers analysis - $(date +'%Y-%m-%d')"
          git push
        fi
        
    - name: Create GitHub Issue with Results
      if: success()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          // Find the latest generated markdown file
          const files = fs.readdirSync('.')
            .filter(file => file.startsWith('ai_papers_weekly_') && file.endsWith('.md'))
            .sort()
            .reverse();
            
          if (files.length > 0) {
            const content = fs.readFileSync(files[0], 'utf8');
            const date = new Date().toISOString().split('T')[0];
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸ“ Weekly AI Papers Ready for Substack - ${date}`,
              body: `## ðŸ¤– Weekly AI Papers Post Generated!

          **File:** \`${files[0]}\`

          ### ðŸŽ¯ Ready to Publish to Substack

          **Quick Steps:**
          1. **Copy the content below** 
          2. **Go to your Substack editor**
          3. **Paste and publish!**
          4. **Close this issue** when done

          ### ðŸ”— Direct Links
          - [ðŸ“„ View File](../../blob/main/${files[0]})
          - [ðŸ“‹ Raw Content](../../raw/main/${files[0]}) â† **Click this to copy easily**

          ### ðŸ“ Content Ready for Substack

          \`\`\`markdown
          ${content.length > 3000 ? content.substring(0, 3000) + '\n\n... [Content truncated - click Raw Content link above for full post]' : content}
          \`\`\`

          ---
          ðŸ¤– *This issue is automatically created every Friday with your weekly AI papers analysis.*

          **âœ… Close this issue** after publishing to Substack.`,
              labels: ["weekly-post", "ready-to-publish"]
            });
          }
